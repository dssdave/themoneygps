<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Did The Money GPS Say? - Search</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <style>
        /* --- Basic & Tab Styles (remain the same) --- */
        body { font-family: sans-serif; line-height: 1.6; padding: 15px; background-color: #f4f4f4; color: #333; }
        #container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #555; font-size: 1.5em; margin-bottom: 15px; }
        mark { background-color: #fcf8e3; padding: 0.2em; border-radius: 3px; }
        .status-message { margin-top: 15px; font-style: italic; color: #888; font-size: 0.9em; min-height: 1.2em; }
        .error-message { color: red; font-weight: bold; }
        .tab-buttons { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
        .tab-button { padding: 8px 15px; cursor: pointer; background: #eee; border: none; border-radius: 4px 4px 0 0; margin-right: 5px; font-size: 0.95em; }
        .tab-button.active { background: #fff; border: 2px solid #eee; border-bottom: 2px solid #fff; font-weight: bold; position: relative; top: 2px;}
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Keyword Search Specific (remain the same) --- */
        #keywordSearchTab .search-controls { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        #keywordSearchTab #searchBox { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px; }
        #keywordSearchTab #searchButton { padding: 10px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #keywordSearchTab #searchButton:hover { background-color: #4cae4c; }
        #keywordSearchTab .search-options { display: flex; align-items: center; }
        #keywordSearchTab .search-options label { margin-left: 5px; font-size: 0.9em; color: #666; cursor: pointer;}
        #keywordResults { margin-top: 20px; }
        .result-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9f9f9; }
        .result-item h3 { margin-top: 0; font-size: 1.0em; color: #444; margin-bottom: 5px; }
        .result-item .meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: #777; margin-bottom: 8px; min-height: 25px; }
        .yt-search-button { font-size: 1em; padding: 3px 8px; color: #fff; background-color: #c4302b; border-radius: 4px; text-decoration: none; white-space: nowrap; margin-left: 10px; }
        .yt-search-button:hover { background-color: #a32824; }
        .result-item p { font-size: 0.9em; color: #555; max-height: 120px; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 8px; margin-top: 8px; white-space: pre-wrap; word-wrap: break-word; }

        /* --- AI Search Specific --- */
        #aiSearchTab .search-controls { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        #aiSearchTab #aiQueryBox { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px; }
        #aiSearchTab #aiSearchButton { padding: 10px 15px; background-color: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #aiSearchTab #aiSearchButton:hover { background-color: #357abd; }
        #aiSearchTab #aiSearchButton:disabled { background-color: #a0c3e8; cursor: not-allowed; }
        #aiResults { margin-top: 10px; /* Reduced top margin */ }
        #aiAnswer { /* Style for the main answer text */
             white-space: pre-wrap; word-wrap: break-word; background-color: #f0f4f8;
             border: 1px solid #d0d8e0; padding: 15px; border-radius: 5px; margin-bottom: 15px;
        }
        #aiSources h4 { margin-bottom: 5px; font-size: 0.9em; color: #555;}
        #aiSources ul { list-style: none; padding: 0; margin: 0; }
        #aiSources li { font-size: 0.85em; margin-bottom: 5px; background-color: #f9f9f9; padding: 5px 8px; border-radius: 3px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        #aiSources li span { margin-right: 10px; } /* Space before link */
        #aiSources .yt-search-button { font-size: 0.9em; padding: 2px 6px; } /* Smaller button for sources */
        #aiStatus { font-size: 0.9em; color: #555; margin-top: 5px; }

    </style>
</head>
<body>
    <div id="container">
        <h1>What Did The Money GPS Say?</h1>

        <div class="tab-buttons">
            <button id="keywordTabButton" class="tab-button active" onclick="openTab(event, 'keywordSearchTab')">Keyword Search</button>
            <button id="aiTabButton" class="tab-button" onclick="openTab(event, 'aiSearchTab')">AI Search</button>
        </div>

        <div id="keywordSearchTab" class="tab-content active">
            <div class="search-controls">
                <input type="text" id="searchBox" placeholder="Enter search term...">
                <button type="button" id="searchButton">Search</button>
                <div class="search-options"> <input type="checkbox" id="fuzzyToggle" checked> <label for="fuzzyToggle">Include Approximate Matches</label> </div>
            </div>
            <div id="keywordStatus" class="status-message">Loading data...</div>
            <div id="keywordResults"></div>
        </div>

        <div id="aiSearchTab" class="tab-content">
            <div class="search-controls">
                 <input type="text" id="aiQueryBox" placeholder="Ask a question (e.g., compare lumber 2021 vs 2023)">
                 <button type="button" id="aiSearchButton">Ask AI</button>
             </div>
             <div id="aiStatus" class="status-message">Enter your question. AI will analyze relevant transcripts & its knowledge.</div>
             <div id="aiResults">
                 <div id="aiAnswer"></div>
                 <div id="aiSources"></div>
             </div>
        </div>

    </div>

    <script>
        // --- Global Variables & References (remain the same) ---
        let transcriptData = []; let fuse = null; let fuzzySearchFailed = false;
        const searchBox = document.getElementById('searchBox'); const searchButton = document.getElementById('searchButton'); const fuzzyToggle = document.getElementById('fuzzyToggle'); const keywordResultsDiv = document.getElementById('keywordResults'); const keywordStatusDiv = document.getElementById('keywordStatus'); const aiQueryBox = document.getElementById('aiQueryBox'); const aiSearchButton = document.getElementById('aiSearchButton'); const aiResultsDiv = document.getElementById('aiResults'); const aiAnswerDiv = document.getElementById('aiAnswer'); const aiSourcesDiv = document.getElementById('aiSources'); const aiStatusDiv = document.getElementById('aiStatus');
        const fuseOptions = { keys: ['text', 'title'], includeScore: true, threshold: 0.4, ignoreLocation: true, minMatchCharLength: 2 };

        // --- Tab Switching Logic (remains the same) ---
        function openTab(evt, tabName) { /* ... */ }
        document.addEventListener('DOMContentLoaded', () => { document.getElementById('keywordSearchTab').style.display = 'block'; document.getElementById('keywordTabButton').classList.add('active'); loadData(); });

        // --- Keyword Search Logic (remains the same) ---
        function initializeFuse() { /* ... */ }
        function performKeywordSearch() { /* ... */ }

        // --- AI Search Logic (Updated Display) ---
         async function performAiSearch() {
            const query = aiQueryBox.value.trim();
            if (!query) { aiStatusDiv.textContent = 'Please enter a question.'; return; }

            aiStatusDiv.textContent = 'Asking AI... Finding relevant context... (this may take a moment or two)';
            aiAnswerDiv.textContent = ''; // Clear previous answer
            aiSourcesDiv.innerHTML = ''; // Clear previous sources
            aiSearchButton.disabled = true;

            try {
                console.log("Sending request to /api/ai-search with query:", query);
                const response = await fetch('/api/ai-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (!response.ok) { throw new Error(data.answer || `Server error: ${response.status}`); }

                // Display the main answer
                aiAnswerDiv.textContent = data.answer || "AI did not provide a text answer.";

                // Display the sources, if any
                if (data.sources && data.sources.length > 0) {
                    let sourcesHtml = '<h4>Sources Used for Context:</h4><ul>';
                    data.sources.forEach(source => {
                        // Basic check if source seems valid
                        if(source.title && source.date && source.youtubeSearchUrl) {
                            sourcesHtml += `
                                <li>
                                    <span>${source.date} - ${source.title}</span>
                                    <a href="${source.youtubeSearchUrl}" target="_blank" class="yt-search-button">Search on YouTube</a>
                                </li>`;
                        }
                    });
                    sourcesHtml += '</ul>';
                    aiSourcesDiv.innerHTML = sourcesHtml;
                    aiStatusDiv.textContent = 'AI response received (context sources listed below):';
                } else if (data.answer) {
                     aiStatusDiv.textContent = 'AI response received (no specific transcript context was used).';
                     aiSourcesDiv.innerHTML = ''; // Ensure sources are cleared if none provided
                 } else {
                      aiStatusDiv.textContent = 'AI response received, but content or sources might be missing.';
                 }


            } catch (error) {
                console.error('AI Search Fetch Error:', error);
                aiAnswerDiv.innerHTML = `<span class="error-message">Error getting AI response: ${error.message || 'Network/server error.'}</span>`;
                aiSourcesDiv.innerHTML = ''; // Clear sources on error
                aiStatusDiv.textContent = 'Failed to get AI response.';
            } finally {
                 aiSearchButton.disabled = false;
            }
        }

        // --- Initial Data Load (remains the same) ---
        async function loadData() { /* ... */ }

        // --- Keyword Search Event Listeners (remain the same) ---
        searchButton.addEventListener('click', function(event) { event.preventDefault(); performKeywordSearch(); });
        searchBox.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); performKeywordSearch(); } });

        // --- AI Search Event Listeners (remain the same) ---
        aiSearchButton.addEventListener('click', function(event) { event.preventDefault(); performAiSearch(); });
        aiQueryBox.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); performAiSearch(); } });

    </script>
</body>
</html>